{% extends "base.html" %}

{% block title %}Pago Pendiente - Cinema App{% endblock %}

{% block extra_head %}
<style>
.pending-container {
    text-align: center;
    padding: 40px 20px;
}

.pending-icon {
    font-size: 4rem;
    color: #ffc107;
    margin-bottom: 20px;
    animation: pulse 2s infinite;
}

.pending-details {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
}

.action-btn {
    background-color: #007bff;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    margin: 10px;
    display: inline-block;
    transition: all 0.3s ease;
}

.action-btn:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
    color: white;
    text-decoration: none;
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
    }
}

.countdown {
    font-size: 1.2em;
    font-weight: bold;
    color: #856404;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <div class="pending-container">
                        <div class="pending-icon">
                            <i class="fas fa-clock"></i>
                        </div>

                        <h2 class="text-warning mb-3">Pago en Proceso</h2>
                        <p class="lead">Tu pago está siendo procesado por MercadoPago.</p>

                        {% if pending_data %}
                        <div class="pending-details">
                            <h6><i class="fas fa-info-circle"></i> Información del Pago</h6>
                            {% if pending_data.payment_id %}
                            <p><strong>ID de Pago:</strong> {{ pending_data.payment_id }}</p>
                            {% endif %}
                            {% if pending_data.status %}
                            <p><strong>Estado:</strong> {{ pending_data.status }}</p>
                            {% endif %}
                            {% if pending_data.external_reference %}
                            <p><strong>Referencia:</strong> {{ pending_data.external_reference }}</p>
                            {% endif %}
                        </div>
                        {% endif %}

                        <div class="alert alert-info">
                            <h6><i class="fas fa-hourglass-half"></i> ¿Qué está pasando?</h6>
                            <ul class="text-left mb-0">
                                <li>Tu pago está siendo verificado por MercadoPago</li>
                                <li>Este proceso puede tomar hasta 24 horas</li>
                                <li>Te notificaremos por email cuando esté confirmado</li>
                                <li>Tus asientos están temporalmente reservados</li>
                            </ul>
                        </div>

                        <div class="countdown">
                            <i class="fas fa-sync fa-spin"></i>
                            Verificando estado cada 30 segundos...
                        </div>

                        <div class="mt-4">
                            <a href="{{ url_for('main.index') }}" class="action-btn">
                                <i class="fas fa-home"></i> Ir al Inicio
                            </a>
                            <a href="{{ url_for('main.cartelera') }}" class="action-btn">
                                <i class="fas fa-film"></i> Ver Cartelera
                            </a>
                        </div>

                        <div class="mt-4">
                            <small class="text-muted">
                                Recibirás un email de confirmación cuando el pago sea procesado.<br>
                                <strong>Consultas:</strong> soporte@cinema.com | (123) 456-7890
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-actualizar el estado cada 30 segundos
{% if pending_data and pending_data.external_reference %}
let checkCount = 0;
const maxChecks = 20; // Máximo 10 minutos

const checkStatus = () => {
    if (checkCount >= maxChecks) {
        return; // Dejar de verificar después de 10 minutos
    }
    
    fetch('/pago-mp/estado/{{ pending_data.external_reference }}')
        .then(response => response.json())
        .then(data => {
            if (data.status && data.status !== 'PENDIENTE') {
                location.reload();
            }
            checkCount++;
        })
        .catch(error => {
            console.log('Error verificando estado:', error);
            checkCount++;
        });
};

// Verificar inmediatamente y luego cada 30 segundos
checkStatus();
setInterval(checkStatus, 30000);
{% endif %}
</script>
{% endblock %}